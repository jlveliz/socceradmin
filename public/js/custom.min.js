

$(function() {
    /*
        GLOBAL CONF
    */
    $.ajaxSetup({
        headers: {
            'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
    });

    /*
        GLOBAL CONF
    */


        /*
            MODALS
        */
        $('#delete-modal').on('show.bs.modal',(event)=>{
            let btnDelete = $(event.relatedTarget);
            let modal = $(event.currentTarget);
           
            let message = btnDelete.data('message');
            let object =  btnDelete.data('object');
            let route =  btnDelete.data('route');
            let nameField = btnDelete.data('fieldname')


            modal.find('.modal-body span.modal-message').text(message)
            modal.find('.modal-body strong.modal-item-name').text(object.name ? object.name : nameField + '?');
            modal.find('.modal-footer .modal-item-key').val(object.id)
            modal.find('.modal-footer form').attr('action',route);
        });

        $('.acept-delete-modal').on('click', function(event) {
            $(event.currentTarget).parent().find('form').submit();  
            $('#delete-modal').modal('hide');
            
        });

        // event open modal
        $('#search-modal').on('show.bs.modal', (event) => {
            let btnPushed = $(event.relatedTarget);
            let modal = $(event.currentTarget);
            //size
            let size = btnPushed.data('size') || '';
            modal.find('.modal-dialog').addClass(size);
            //title
            let title = btnPushed.data('title') || '';
            if(!title) { 
                modal.find('.modal-title').remove();
            } else {
                modal.find('.modal-title').text(title);
            }
           

            //route form
            let route = btnPushed.data('route') || '#';
            modal.find('form').prop('action',route); 
        });

        //event close modal 
        $("#search-modal").on('hide.bs.modal',(event) => {
            let modal = $(event.currentTarget);
            
            //reset form
            modal.find('form input').val('').focus();
            let htmlData="<tr><td colspan='2'><p class='text-center'>No existen datos a consultar</p></td></tr>";
            $("#table-results-search tbody tr").remove();
            $("#table-results-search tbody").append(htmlData);
        })

        //when click on 'select'
        $('#table-results-search tbody').on('click','.close-search-modal',(event) => {
            let btnTrigger = $(event.currentTarget)
            let resource = btnTrigger.attr('resource');
            $("#table-results-search").trigger('resource-selected',JSON.parse(resource));
        });




        /* Search Modals */
        $('.btn-search').on('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            let btnSumit = event.currentTarget;
            let form  = $(btnSumit).parent('form');
            let inptIserted = form.find('input[type=text]').val();
            let alertSearch = $("#alert-modal-search")
            //effects
            form.find('input[type=text]').prop('readonly',true);
            $(btnSumit).prop('disabled',true).find('i').removeClass('fa-search').addClass('fa-spinner fa-spin');
            //
            $.ajax({
                method : 'POST',
                url : form.prop('action'),
                data : {query: inptIserted}
            })
            .done((data) => {
                let htmlData = "";
                if(data.length > 0) {
                    data.forEach( (item, key ) => {
                        htmlData+= "<tr>";
                        htmlData+='<td>' + item.name +' '+ item.last_name + '</td>';
                        htmlData+="<td> <button resource='"+JSON.stringify(item)+"' class='btn btn-warning btn-flat btn-sm close-search-modal' data-dismiss='modal'><i class='fa fa-check'></i></button></td>";
                        htmlData+="<tr>";
                    })
                } else {
                    htmlData+="<tr><td colspan='2'><p class='text-center'>No existen datos a consultar</p></td></tr>";
                }
                $("#table-results-search tbody tr").remove();
                $("#table-results-search tbody").append(htmlData);
            })
            .fail((error) => {
                
            })
            .always((event) => {
                //remove effects
                form.find('input[type=text]').removeAttr('readonly');
                $(btnSumit).removeAttr('disabled').find('i').removeClass('fa-spinner fa-spin').addClass('fa-search');
            })
        })



        /* FIN MODALS */ 

        /*
            SAVE AND CLOSE
        */
        $('.save-close').on('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            $("#redirect-index").val(1);
            $('.crud-futbol').submit();
        });


        /*LOGOUT*/
        $('.logout-btn').on('click', function(event) {
            event.preventDefault();
            $("#logout-form").submit();
        });



        /* ROLES - CHECK ALL CHILDRENS */
        $(".input-menu-has-children").on('click', function(event) {
            var tableForCheck = $(this).attr('for');
            if($(this).is(':checked')) {
                $("#"+tableForCheck+' input[type=checkbox]').prop('checked', 'checked');
            } else {
                $("#"+tableForCheck+' input[type=checkbox]').prop('checked',false);
            }

        });

        /* ROLES - CHECK PARENT */
        $(".form-check-input").on('click', function(event) {
            var parentId = $(this).attr('parent');
            
            if($(this).is(':checked')) { 
                //check parent permission
                if(!$("#permission_"+parentId).is(':checked')){
                    $("#permission_"+parentId).prop('checked', 'checked');
                }
            }

        });


        
});
